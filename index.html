<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8" />
    <title>Simple Cache Header Checker</title>
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <style>
        body {
            margin: 0;
            padding: 20px;
            font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
            background: #0f172a;
            color: #e5e7eb;
        }

        .container {
            max-width: 700px;
            margin: 0 auto;
            padding: 20px 18px 24px;
            background: #020617;
            border-radius: 10px;
            border: 1px solid #1f2937;
        }

        h1 {
            margin: 0 0 4px;
            font-size: 22px;
        }

        p {
            margin: 0 0 14px;
            font-size: 13px;
            color: #9ca3af;
        }

        label {
            display: block;
            font-size: 12px;
            margin-bottom: 4px;
        }

        input[type="text"] {
            width: 100%;
            padding: 8px 10px;
            border-radius: 6px;
            border: 1px solid #4b5563;
            font-size: 13px;
            background: #020617;
            color: #e5e7eb;
        }

        input[type="text"]::placeholder {
            color: #6b7280;
        }

        button {
            margin-top: 10px;
            padding: 8px 14px;
            border-radius: 6px;
            border: none;
            background: #3b82f6;
            color: white;
            font-size: 13px;
            cursor: pointer;
        }

        button:disabled {
            opacity: 0.6;
            cursor: default;
        }

        .error {
            margin-top: 8px;
            color: #fecaca;
            font-size: 12px;
        }

        .section {
            margin-top: 16px;
            padding-top: 10px;
            border-top: 1px solid #1f2937;
        }

        dl {
            margin: 0;
            font-size: 13px;
        }

        dt {
            font-weight: 500;
            margin-top: 6px;
        }

        dd {
            margin: 2px 0 0 0;
            color: #d1d5db;
            font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", monospace;
            font-size: 12px;
        }
    </style>
</head>

<body>
    <div class="container">
        <h1>Cache Header Checker</h1>
        <p>Enter a URL and see if it has cache headers, how long they last, and when it expires.</p>

        <label for="url">URL</label>
        <input id="url" type="text" placeholder="https://example.com" />
        <button id="check">Check cache headers</button>
        <div id="error" class="error" style="display:none;"></div>

        <div class="section">
            <dl>
                <dt>Is it cached?</dt>
                <dd id="from-cache">–</dd>

                <dt>How old is it?</dt>
                <dd id="resource-age">–</dd>

                <dt>How long can it stay in cache?</dt>
                <dd id="max-lifetime">–</dd>

                <dt>How much time is left before it expires?</dt>
                <dd id="time-left">–</dd>
            </dl>
        </div>
    </div>

    <script>
        const urlInput = document.getElementById("url");
        const checkBtn = document.getElementById("check");
        const errorEl = document.getElementById("error");

        const fromCacheEl = document.getElementById("from-cache");
        const resourceAgeEl = document.getElementById("resource-age");
        const maxLifetimeEl = document.getElementById("max-lifetime");
        const timeLeftEl = document.getElementById("time-left");

        function showError(msg) {
            if (!msg) {
                errorEl.style.display = "none";
                errorEl.textContent = "";
                return;
            }
            errorEl.style.display = "block";
            errorEl.textContent = msg;
        }

        function normalizeUrl(raw) {
            let value = (raw || "").trim();
            if (!value) return "";
            if (!/^https?:\/\//i.test(value)) {
                value = "https://" + value;
            }
            try {
                return new URL(value).toString();
            } catch {
                return "";
            }
        }

        function parseMaxAge(cacheControl) {
            if (!cacheControl) return null;
            const parts = cacheControl.split(",").map(p => p.trim());
            for (const part of parts) {
                const [key, val] = part.split("=");
                if (key.toLowerCase() === "max-age" && val !== undefined) {
                    const n = Number(val);
                    if (Number.isFinite(n)) return n;
                }
            }
            return null;
        }

        function formatDuration(sec) {
            if (sec == null || !isFinite(sec)) return "";
            if (sec < 0) sec = 0;
            const s = Math.floor(sec);
            if (s === 0) return "0 s";
            const parts = [];
            const units = [
                [" d", 86400],
                [" h", 3600],
                [" min", 60],
                [" s", 1],
            ];
            let remaining = s;
            for (const [label, size] of units) {
                if (remaining >= size) {
                    const value = Math.floor(remaining / size);
                    remaining %= size;
                    parts.push(value + label);
                }
            }
            return parts.join(" ");
        }

        async function checkCache() {
            showError("");

            const url = normalizeUrl(urlInput.value);
            if (!url) {
                showError("Unesi valjani URL (npr. https://example.com).");
                return;
            }

            fromCacheEl.textContent = "–";
            resourceAgeEl.textContent = "–";
            maxLifetimeEl.textContent = "–";
            timeLeftEl.textContent = "–";

            checkBtn.disabled = true;

            try {
                const res = await fetch(url, { method: "HEAD", headers: { "Fastly-Debug": "1" } });


                const cacheControl = res.headers.get("cache-control");
                const expires = res.headers.get("expires");
                const ageHeader = res.headers.get("age");
                const dateHeader = res.headers.get("date");

                const now = new Date();

                let ageSeconds = null;
                if (ageHeader != null) {
                    const num = Number(ageHeader);
                    if (Number.isFinite(num) && num >= 0) ageSeconds = num;
                } else if (dateHeader) {
                    const d = new Date(dateHeader);
                    if (!isNaN(d.getTime())) {
                        ageSeconds = (now.getTime() - d.getTime()) / 1000;
                    }
                }

                if (ageSeconds != null && ageSeconds > 0.5) {
                    fromCacheEl.textContent =
                        "Da – vrlo vjerojatno iz cachea (procijenjena starost oko " +
                        formatDuration(ageSeconds) +
                        ").";
                } else if (ageSeconds !== null) {
                    fromCacheEl.textContent =
                        "Vjerojatno svježe sa servera (bez vidljivo veće starosti u cacheu).";
                } else {
                    fromCacheEl.textContent =
                        "Ne znamo – server nije poslao informacije o starosti (Age/Date header).";
                }

                if (ageSeconds != null) {
                    resourceAgeEl.textContent =
                        "Oko " + formatDuration(ageSeconds) +
                        " od trenutka kada je server pripremio ovaj odgovor.";
                } else {
                    resourceAgeEl.textContent =
                        "Nije moguće izračunati – nema pouzdanih podataka o starosti.";
                }

                let maxAge = parseMaxAge(cacheControl);

                let dateForLifetime = null;
                if (dateHeader) {
                    const d = new Date(dateHeader);
                    if (!isNaN(d.getTime())) {
                        dateForLifetime = d;
                    }
                }

                let expiresDate = null;
                if (expires) {
                    const d = new Date(expires);
                    if (!isNaN(d.getTime())) {
                        expiresDate = d;
                    }
                }

                let maxLifetimeSeconds = null;
                if (maxAge != null) {
                    maxLifetimeSeconds = maxAge;
                    maxLifetimeEl.textContent =
                        "Najviše oko " + formatDuration(maxLifetimeSeconds) +
                        " (" + maxLifetimeSeconds + " s) od trenutka odgovora.";
                } else if (expiresDate && dateForLifetime) {
                    maxLifetimeSeconds = (expiresDate.getTime() - dateForLifetime.getTime()) / 1000;
                    maxLifetimeEl.textContent =
                        "Procijenjeno: od odgovora do " +
                        expiresDate.toLocaleString() +
                        " (" + formatDuration(maxLifetimeSeconds) + ").";
                } else {
                    maxLifetimeEl.textContent =
                        "Ne znamo – server nije jasno rekao koliko dugo resurs smije biti u cacheu.";
                }

                let timeLeftSeconds = null;
                if (maxLifetimeSeconds != null && ageSeconds != null) {
                    timeLeftSeconds = maxLifetimeSeconds - ageSeconds;
                } else if (expiresDate) {
                    timeLeftSeconds = (expiresDate.getTime() - now.getTime()) / 1000;
                }

                if (timeLeftSeconds != null && isFinite(timeLeftSeconds)) {
                    if (timeLeftSeconds > 0) {
                        timeLeftEl.textContent =
                            "Još otprilike " + formatDuration(timeLeftSeconds) +
                            " prije nego što izađe iz cachea (postane zastario).";
                    } else {
                        timeLeftEl.textContent =
                            "Resurs je vjerojatno već istekao – prošlo je oko " +
                            formatDuration(Math.abs(timeLeftSeconds)) +
                            " od isteka.";
                    }
                } else {
                    timeLeftEl.textContent =
                        "Nije moguće procijeniti – nema dovoljno podataka o trajanju i starosti.";
                }
            } catch (err) {
                console.error(err);
                showError("Could not read headers. The site may block cross-origin requests (CORS) or be unreachable.");
                rawHeadersEl.textContent = "(no headers – request failed or was blocked)";
            } finally {
                checkBtn.disabled = false;
            }
        }

        checkBtn.addEventListener("click", checkCache);
        urlInput.addEventListener("keydown", (e) => {
            if (e.key === "Enter") {
                e.preventDefault();
                checkCache();
            }
        });
    </script>
</body>

</html>